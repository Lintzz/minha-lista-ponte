<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Autenticando...</title>
</head>
<body>
    <p id="status-message">Por favor, complete o login na janela pop-up.</p>
    <button id="login-button" style="display: none;">Tentar Login Novamente</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTdAqCIi3YsvrJUo958ZHLBj9OD2MjKR8",
            authDomain: "minha-lista-desktop.firebaseapp.com",
            projectId: "minha-lista-desktop",
            storageBucket: "minha-lista-desktop.firebasestorage.app",
            messagingSenderId: "954288998094",
            appId: "1:954288998094:web:80ce2579d95670c023f29f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const statusMessage = document.getElementById('status-message');
        const loginButton = document.getElementById('login-button');

        async function startLogin() {
            try {
                const provider = new GoogleAuthProvider();
                
                // Usa o signInWithPopup, que é mais direto
                const result = await signInWithPopup(auth, provider);
                
                statusMessage.textContent = "Sucesso! Redirecionando de volta para o aplicativo...";
                
                const credential = GoogleAuthProvider.credentialFromResult(result);
                if (credential) {
                    const idToken = credential.idToken;
                    // Redireciona para o deep link do seu app com o token
                    window.location.href = `minha-lista://callback?idToken=${idToken}`;
                } else {
                    throw new Error("Não foi possível extrair a credencial do resultado.");
                }

            } catch (error) {
                console.error("Erro no processo de autenticação:", error);
                
                // Se o usuário fechar o pop-up, o erro é 'auth/popup-closed-by-user'
                if (error.code === 'auth/popup-closed-by-user') {
                    statusMessage.textContent = "A janela de login foi fechada. Você pode fechar esta aba ou tentar novamente.";
                } else {
                    statusMessage.innerHTML = `<p>Ocorreu um erro: ${error.message}</p>`;
                }
                
                loginButton.style.display = 'block'; // Mostra o botão para tentar de novo
            }
        }

        loginButton.addEventListener('click', startLogin);

        // Inicia o processo de login assim que a página carrega
        startLogin();
    </script>
</body>
</html>