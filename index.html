<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Autenticando...</title>
    </head>
<body>
    <p id="status-message">Aguarde um momento, estamos processando sua autenticação...</p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // Importa as novas funções de persistência
        import { getAuth, getRedirectResult, GoogleAuthProvider, signInWithRedirect, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTdAqCIi3YsvrJUo958ZHLBj9OD2MjKR8",
            authDomain: "minha-lista-desktop.firebaseapp.com",
            projectId: "minha-lista-desktop",
            storageBucket: "minha-lista-desktop.firebasestorage.app",
            messagingSenderId: "954288998094",
            appId: "1:954288998094:web:80ce2579d95670c023f29f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const statusMessage = document.getElementById('status-message');

        // Função principal assíncrona para lidar com o login
        async function handleAuth() {
            try {
                // Define a persistência para ser mais robusta
                await setPersistence(auth, browserLocalPersistence);
                console.log("Persistência definida. Verificando resultado do redirecionamento...");

                const result = await getRedirectResult(auth);
                console.log("Resultado do getRedirectResult:", result);

                if (result) {
                    console.log("Resultado encontrado!", result);
                    statusMessage.textContent = "Sucesso! Redirecionando de volta para o aplicativo...";
                    
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    if (credential) {
                        const idToken = credential.idToken;
                        console.log("idToken extraído. Redirecionando para o deep link...");
                        window.location.href = `minha-lista://callback?idToken=${idToken}`;
                    } else {
                         throw new Error("Não foi possível extrair a credencial do resultado.");
                    }
                    
                } else {
                    console.log("Nenhum resultado de redirecionamento encontrado. Iniciando o login...");
                    statusMessage.textContent = "Você será redirecionado para a página de login do Google.";
                    
                    const provider = new GoogleAuthProvider();
                    await signInWithRedirect(auth, provider);
                }
            } catch (error) {
                console.error("Erro no processo de autenticação:", error);
                statusMessage.innerHTML = `<p>Ocorreu um erro. Por favor, feche esta janela e tente novamente.</p><p>Erro: ${error.code} - ${error.message}</p>`;
            }
        }

        // Inicia o processo
        handleAuth();
    </script>
</body>
</html>